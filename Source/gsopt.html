<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Guardian Site Coverage Optimizer</title>
	<style type="text/css">
.tar {
	text-align: right;
}

HTML, BODY {
	font-family: Tahoma, Geneva, Arial, Verdana, sans-serif;
	font-size: 100%;
}

A {
	text-decoration: none;
	color: #00c;
}
A:hover {
	text-decoration: underline;
}

UL {
	margin: 0;
	padding: 0;
	padding-left: 2em;
}

LI {
	margin: 0;
	padding: 0;
	margin-left: -0.75em;
}

FORM {
	margin: 0;
	padding: 0;
}

SPAN#span_controls {
	font-size: 0.8em;
	font-weight: bold;
}
SPAN#span_progress {
	display: inline-block;
	vertical-align: bottom;
	height: 1em;
	width: 0;
	background-color: blue;
}

TABLE {
	border-collapse: collapse;
	border-spacing: 0;
	font-size: 0.8em;
	overflow: hidden;
}

TBODY TR.selected {
	background-color: #dfd;
}
TBODY TR:hover {
	background-color: #ffd;
}
TBODY TR.selected:hover {
	background-color: #efd;
}

TH {
	border: 1px solid black;
	padding: 0 0.5em;
	white-space: nowrap;
}
THEAD TH {
	background-color: #eee;
}
TH.info {
	border: none;
	background: none;
	padding: 0;
	text-align: left;
}
TBODY TH {
	font-weight: normal;
	text-align: left;
}

TD {
	position: relative;
	padding: 0;
}
TD.last_in_cat {
	border-right: 1px solid black;
}
TR:last-child TD {
	border-bottom: 1px solid black;
}
THEAD TD {
	width: 1%;
	text-align: center;
}

TD::after {
	display: none;
	content: '';
	position: absolute;
	left: 0;
	top: -5000px;
	height: 10000px;
	right: 0;
}
TD:hover::after {
	display: block;
	z-index: -1;
	background-color: #ffc;
	opacity: 0.5;
}
THEAD TD.selected::after {
	display: block;
	z-index: -2;
	background-color: #fdd;
}
THEAD TD.covered::after {
	display: block;
	z-index: -2;
	background-color: #dfd;
}

BUTTON {
	padding: 0 0.5em;
}

INPUT {
	margin: 0;
	padding: 0;
	vertical-align: bottom;
}
INPUT.text_opt {
	width: 3em;
	font-size: 0.8em;
	vertical-align: baseline;
}
THEAD INPUT.checkbox_codex {
	display: none;
}
THEAD TD ABBR::after {
	content: '\25AB';
}
THEAD TD INPUT.checkbox_codex:checked + ABBR::after {
	content: '\25AA';
}

TD ABBR {
	display: inline-block;
	width: 100%;
	text-decoration: none;
	text-align: center;
	cursor: pointer;
}
LABEL {
	padding: 0 1px;
}

DIV#div_layer {
	display: none;
	position: fixed;
	z-index: 10;
	top: 0;
	left: 0;
	right: 0;
	bottom: 0;
	background-color: rgba(128, 128, 128, 0.66);
}

DIV#div_wrapper {
	display: inline-block;
	margin: 4em;
	max-width: 85%;
	max-height: 85%;
	overflow: auto;
	box-shadow: 0 0 2em 2em rgba(0,0,0,0.5);
	border: 2px solid black;
	background-color: white;
	padding: 0.5em;
}

DIV#div_export,
DIV#div_export_detail {
	display: none;
	white-space: pre;
	font-family: Courier, "Times New Roman", serif;
	font-size: 0.8em;
}

DIV#div_layer BUTTON {
	position: relative;
	left: 5em;
	top: -5em;
}
	</style>
	<script type="text/javascript">
var DROP_FAR_SITES = false;
var ONLY_VERIFIED = false;
var TEST_PORTION = 1;
var ALLOW_EXTRA_SITE = false;
var dataURLs = {
	'artifact': 'https://api.canonn.technology/api/v1/artifacts',
	'category': 'https://api.canonn.technology/api/v1/codex/categories',
	'codex': 'https://api.canonn.technology/api/v1/codex/data',
	'system': 'https://api.canonn.technology/api/v1/stellar/systems',
	'body': 'https://api.canonn.technology/api/v1/stellar/bodies',
	'site': 'https://api.canonn.technology/api/v1/ruinsites',
	'type': 'https://api.canonn.technology/api/v1/ruins/types',
	'obelisk': 'https://api.canonn.technology/api/v1/obelisks',
	'group': 'https://api.canonn.technology/api/v1/obelisks/groups',
};
var db = {};


function onDOMContentLoaded(e) {
	var div = document.createElement('DIV');
	div.id = 'div_loading';
	div.innerText = 'loading';
	document.body.appendChild(div);
	getNextDataType();
} // onDOMContentLoaded()


function getNextDataType() {
	for (var datatype in dataURLs) {
		if (!db[datatype]) {
			var request = new XMLHttpRequest();
			request.onreadystatechange = function() {
				if (request.readyState == 4)
					loadDataType(datatype, JSON.parse(request.responseText));
			};
			request.open('GET', dataURLs[datatype], true);
			request.send();
			return;
		}
	}
	getNextSiteObelisks();
} // getNextDataType()


function loadDataType(datatype, data) {
	db[datatype] = {};
	for (var i = 0;  i < data.length;  i++) {
		if (datatype == 'site' && (data[i].id >= 99990 || (DROP_FAR_SITES && (data[i].id == 68 || data[i].id == 69 || data[i].id == 92))))
			continue;
		db[datatype][data[i].id] = data[i];
	}
	document.getElementById('div_loading').innerText += '.';
	getNextDataType();
} // loadDataType()


function getNextSiteObelisks() {
	for (var siteId in db.site) {
		if (!db.site[siteId].obelisks) {
			db.site[siteId].obelisks = [];
			db.site[siteId].codexes = [];
			var request = new XMLHttpRequest();
			request.onreadystatechange = function() {
				if (request.readyState == 4) {
					if (request.status == 200) {
						loadSiteObelisks(siteId, JSON.parse(request.responseText));
					} else {
						getNextSiteObelisks();
					}
				}
			};
			request.open('GET', 'https://api.canonn.technology/api/v1/ruinsites/'+siteId+'/activeobelisks', true);
			request.send();
			return;
		}
	}
	initUI();
} // getNextSiteObelisks()


function loadSiteObelisks(siteId, data) {
	var site = db.site[siteId];
	for (var i = 0;  i < data.length;  i++) {
		var obelisk = db.obelisk[data[i].id];
		site.obelisks.push(obelisk);
		if (!obelisk.sites)
			obelisk.sites = [];
		obelisk.sites.push(site);
		
		var codex = db.codex[data[i].codexdataId];
		if (!data[i].isBroken && codex && (!codex.sites || codex.sites[codex.sites.length-1] != site)) {
			site.codexes.push(codex);
			if (!codex.sites)
				codex.sites = [];
			codex.sites.push(site);
		}
	}
	document.getElementById('div_loading').innerText += '.';
	getNextSiteObelisks();
} // loadSiteObelisks()


var namecmp = function(obj1, obj2) { return (obj1.name < obj2.name) ? -1 : ((obj1.name === obj2.name) ? 0 : 1); };
var codexcmp = function(codex1, codex2) { return (codex1.categoryId != codex2.categoryId) ? namecmp(db.category[codex1.categoryId], db.category[codex2.categoryId]) : (codex1.entryNumber - codex2.entryNumber); };
var obeliskcmp = function(ob1, ob2) { return (ob1.obeliskgroupId != ob2.obeliskgroupId) ? namecmp(db.group[ob1.obeliskgroupId], db.group[ob2.obeliskgroupId]) : (ob1.number - ob2.number); };
var sitecmp = function(site1, site2) { return (site1.id - site2.id); };


function initUI() {
	var categories = [];
	for (var catId in db.category) {
		categories.push(db.category[catId]);
	}
	categories.sort(namecmp);
	
	var codexes = [], catSize = {};
	for (var codexId in db.codex) {
		codexes.push(db.codex[codexId]);
		var catId = db.codex[codexId].categoryId;
		if (!catSize[catId])
			catSize[catId] = 0;
		catSize[catId]++;
	}
	codexes.sort(codexcmp);
	
	var sites = [];
	for (var siteId in db.site) {
		sites.push(db.site[siteId]);
		db.site[siteId].obelisks.sort(obeliskcmp);
	}
	sites.sort(sitecmp);
	
	
	var form, table, thead, tbody, tr, th, td, button, label, input, abbr, div, span, alink;
	form = document.createElement('FORM');
	span = document.createElement('SPAN');
	span.id = 'span_controls';
	button = document.createElement('BUTTON');
	button.innerText = 'Reset';
	button.addEventListener('click', function(e) {
		e.preventDefault();
		e.stopPropagation();
		document.forms[0].reset();
		updateSiteCover();
	});
	span.appendChild(button);
	button = document.createElement('BUTTON');
	button.innerText = 'Optimize';
	button.addEventListener('click', function(e) {
		e.preventDefault();
		e.stopPropagation();
		setTimeout(optimizeSiteCoverage, 1);
	});
	span.appendChild(button);
	button = document.createElement('BUTTON');
	button.innerText = 'Export';
	button.addEventListener('click', function(e) {
		e.preventDefault();
		e.stopPropagation();
		document.getElementById('div_layer').style.display = 'block';
		document.getElementById('div_export').style.display = 'block';
		document.getElementById('div_export_detail').style.display = 'none';
		if (document.selection) {
			var range = document.body.createTextRange();
			range.moveToElementText(document.getElementById('div_export'));
			range.select();
		} else if (window.getSelection) {
			var range = document.createRange();
			range.selectNode(document.getElementById('div_export'));
			window.getSelection().removeAllRanges();
			window.getSelection().addRange(range);
		}
	});
	span.appendChild(button);
	button = document.createElement('BUTTON');
	button.innerText = '(detailed)';
	button.addEventListener('click', function(e) {
		e.preventDefault();
		e.stopPropagation();
		document.getElementById('div_layer').style.display = 'block';
		document.getElementById('div_export').style.display = 'none';
		document.getElementById('div_export_detail').style.display = 'block';
		if (document.selection) {
			var range = document.body.createTextRange();
			range.moveToElementText(document.getElementById('div_export_detail'));
			range.select();
		} else if (window.getSelection) {
			var range = document.createRange();
			range.selectNode(document.getElementById('div_export_detail'));
			window.getSelection().removeAllRanges();
			window.getSelection().addRange(range);
		}
	});
	span.appendChild(button);
	abbr = document.createElement('ABBR');
	abbr.title = 'Optimize route assuming equivalent time to jump X lightyears, cruise Y lightseconds or land at Z sites';
	abbr.appendChild(document.createTextNode('Opt:'));
	span.appendChild(document.createTextNode(' '));
	span.appendChild(abbr);
	span.appendChild(document.createTextNode(' '));
	input = document.createElement('INPUT');
	input.id = 'text_opt_ly';
	input.className = 'text_opt';
	input.type = 'text';
	input.defaultValue = input.value = '45';
	span.appendChild(input);
	span.appendChild(document.createTextNode(' LY = '));
	input = document.createElement('INPUT');
	input.id = 'text_opt_ls';
	input.className = 'text_opt';
	input.type = 'text';
	input.defaultValue = input.value = '10000';
	span.appendChild(input);
	span.appendChild(document.createTextNode(' LS = '));
	input = document.createElement('INPUT');
	input.id = 'text_opt_site';
	input.className = 'text_opt';
	input.type = 'text';
	input.defaultValue = input.value = '0.5';
	span.appendChild(input);
	span.appendChild(document.createTextNode(' landings'));
	form.appendChild(span);
	
	table = document.createElement('TABLE');
	thead = document.createElement('THEAD');
	thead.addEventListener('click', function(e) {
		for (var tgt = e.target;  tgt && tgt.tagName !== 'TD';  tgt = tgt.parentNode)
			;
		tgt = tgt && tgt.getElementsByTagName('INPUT')[0];
		if (!tgt)
			return;
		if (tgt.id.substring(0,15) === 'checkbox_codex_') {
			if (tgt !== e.target) {
				tgt.checked = !tgt.checked;
				e.preventDefault();
			}
			e.stopPropagation();
			updateSiteCover();
		}
	});
	
	tr = document.createElement('TR');
	th = document.createElement('TH');
	th.className = 'info';
	th.colSpan = 6;
	input = document.createElement('INPUT');
	input.id = 'checkbox_codex_all';
	input.className = 'checkbox_codex';
	input.type = 'checkbox';
	input.checked = true;
	th.appendChild(input);
	span = document.createElement('SPAN');
	span.id = 'span_progress';
	th.appendChild(span);
	span = document.createElement('SPAN');
	span.id = 'span_info';
	th.appendChild(span);
	tr.appendChild(th);
	for (var c = 0;  c < categories.length;  c++) {
		th = document.createElement('TH');
		th.appendChild(document.createTextNode(categories[c].name));
		th.colSpan = catSize[categories[c].id];
		tr.appendChild(th);
	}
	thead.appendChild(tr);
	
	tr = document.createElement('TR');
	th = document.createElement('TH');
	th.appendChild(document.createTextNode('GS#'));
	tr.appendChild(th);
	th = document.createElement('TH');
	th.appendChild(document.createTextNode('System'));
	tr.appendChild(th);
	th = document.createElement('TH');
	th.appendChild(document.createTextNode('Body'));
	tr.appendChild(th);
	th = document.createElement('TH');
	th.appendChild(document.createTextNode('Lat.'));
	tr.appendChild(th);
	th = document.createElement('TH');
	th.appendChild(document.createTextNode('Long.'));
	tr.appendChild(th);
	th = document.createElement('TH');
	th.appendChild(document.createTextNode('T'));
	tr.appendChild(th);
	for (var c = 0;  c < codexes.length;  c++) {
		var codex = codexes[c];
		td = document.createElement('TD');
		td.id = 'td_codex_' + codex.id;
		if (c+1 >= codexes.length || codexes[c+1].categoryId != codex.categoryId)
			td.className = 'last_in_cat';
		label = document.createElement('LABEL');
		input = document.createElement('INPUT');
		input.id = 'checkbox_codex_' + codex.id;
		input.className = 'checkbox_codex';
		input.type = 'checkbox';
		label.appendChild(input);
		abbr = document.createElement('ABBR');
		abbr.title = db.category[codex.categoryId].name + ' ' + codex.entryNumber;
	//	abbr.appendChild(document.createTextNode('\u25AA')); // 25A0-1 large, 25AA-B small, 25FE-F medium
		label.appendChild(abbr);
		td.appendChild(label);
		tr.appendChild(td);
	}
	thead.appendChild(tr);
	
	table.appendChild(thead);
	tbody = document.createElement('TBODY');
	tbody.addEventListener('click', function(e) {
		if (e.target.tagName === 'A')
			return;
		for (var tgt = e.target;  tgt && tgt.tagName !== 'TR';  tgt = tgt.parentNode)
			;
		tgt = tgt && tgt.getElementsByTagName('INPUT')[0];
		if (!tgt)
			return;
		if (tgt.id.substring(0,14) === 'checkbox_site_') {
			if (tgt !== e.target) {
				tgt.checked = !tgt.checked;
				e.preventDefault();
			}
			e.stopPropagation();
			updateSiteCover();
		}
	});
	
	var typeSymbol = { 'Alpha':'\u03B1', 'Beta':'\u03B2', 'Gamma':'\u03B3' };
	for (var s = 0;  s < sites.length;  s++) {
		var site = sites[s];
		tr = document.createElement('TR');
		tr.id = 'tr_site_' + site.id;
		
		th = document.createElement('TH');
		input = document.createElement('INPUT');
		input.id = 'checkbox_site_' + site.id;
		input.className = 'checkbox_site';
		input.type = 'checkbox';
		th.appendChild(input);
		alink = document.createElement('A');
		alink.href = 'https://ruins.canonn.technology/#GS' + site.id;
		alink.appendChild(document.createTextNode('GS'+site.id));
		th.appendChild(alink);
		tr.appendChild(th);
		th = document.createElement('TH');
		th.appendChild(document.createTextNode(db.system[db.body[site.bodyId].systemId].name));
		tr.appendChild(th);
		th = document.createElement('TH');
		th.appendChild(document.createTextNode(db.body[site.bodyId].name));
		tr.appendChild(th);
		th = document.createElement('TH');
		th.className = 'tar';
		th.appendChild(document.createTextNode(site.latitude.toFixed(2)));
		tr.appendChild(th);
		th = document.createElement('TH');
		th.className = 'tar';
		th.appendChild(document.createTextNode(site.longitude.toFixed(2)));
		tr.appendChild(th);
		th = document.createElement('TH');
		th.appendChild(document.createTextNode(typeSymbol[db.type[site.ruintypeId].name] || '?'));
		tr.appendChild(th);
		
		var codexdetail={}, codexverified={};
		for (var o = 0;  o < site.obelisks.length;  o++) {
			var obelisk = site.obelisks[o];
			var codex = db.codex[obelisk.codexdataId];
			if (codex && !obelisk.isBroken) {
				codexdetail[codex.id] = (codexdetail[codex.id] || '') + ' ' + db.group[obelisk.obeliskgroupId].name + obelisk.number + (obelisk.isVerified ? '' : '?');
				if (obelisk.isVerified)
					codexverified[codex.id] = true;
			}
		}
		for (var c = 0;  c < codexes.length;  c++) {
			td = document.createElement('TD');
			if (c+1 >= codexes.length || codexes[c+1].categoryId != codexes[c].categoryId)
				td.className = 'last_in_cat';
			if (codexdetail[codexes[c].id]) {
				abbr = document.createElement('ABBR');
				abbr.title = db.category[codexes[c].categoryId].name + ' ' + codexes[c].entryNumber + ':' + codexdetail[codexes[c].id];
				abbr.appendChild(document.createTextNode(codexverified[codexes[c].id] ? '\u2022' : '\u2218'));
				td.appendChild(abbr);
			}
			tr.appendChild(td);
		}
		
		tbody.appendChild(tr);
	}
	table.appendChild(tbody);
	form.appendChild(table);
	
	document.body.removeChild(document.getElementById('div_loading'));
	document.body.appendChild(form);
	
	
	var divL = document.createElement('DIV');
	divL.id = 'div_layer';
	var divW = document.createElement('DIV');
	divW.id = 'div_wrapper';
	var divE = document.createElement('DIV');
	divE.id = 'div_export';
	divW.appendChild(divE);
	var divEd = document.createElement('DIV');
	divEd.id = 'div_export_detail';
	divW.appendChild(divEd);
	button = document.createElement('BUTTON');
	button.innerText = 'Close';
	button.addEventListener('click', function(e) {
		e.preventDefault();
		e.stopPropagation();
		document.getElementById('div_layer').style.display = 'none';
	});
	divL.appendChild(divW);
	divL.appendChild(document.createElement('BR'));
	divL.appendChild(button);
	document.body.appendChild(divL);
	
	document.addEventListener('keydown', function(e) {
		if ((e.key == 'Escape') || ((e.keyCode || e.which) == 27)) {
			var layer = document.getElementById('div_layer');
			if (layer.style.display != 'none') {
				e.preventDefault();
				e.stopPropagation();
				layer.style.display = 'none';
			}
		}
	});
} // initUI()


function updateSiteCover() {
	var allcodexes = document.getElementById('checkbox_codex_all').checked;
	var sitelist=[], codexflag={}, codexneed={}, numneed=0;
	for (var siteId in db.site) {
		var tr = document.getElementById('tr_site_'+siteId);
		if (document.getElementById('checkbox_site_'+siteId).checked) {
			tr.className = 'selected';
			var site = db.site[siteId];
			sitelist.push(site);
			var c = site.codexes.length;
			while (c-- > 0) {
				codexflag[site.codexes[c].id] = true;
				if (allcodexes || document.getElementById('checkbox_codex_' + site.codexes[c].id).checked) {
					if (!codexneed[site.codexes[c].id]) {
						codexneed[site.codexes[c].id] = true;
						numneed++;
					}
				}
			}
		} else {
			tr.className = '';
		}
	}
	var soln = { 'sitelist':sitelist };
	evaluateSolution(soln);
	
	var line = sitelist.length+' sites on '+soln.numbodies+' bodies in '+soln.numsystems+' systems; ~'+soln.distLY.toFixed(0)+' LY, ~'+soln.distLS.toFixed(0)+' LS';
	var span = document.getElementById('span_info');
	var divexport = document.getElementById('div_export');
	var divexportd = document.getElementById('div_export_detail');
	var numscanned = 0;
	if (sitelist.length > 0) {
		span.innerText = line;
		var text = line + '<ul><li>Begin: Meene / Felice Dock';
		var textd = text;
		for (var s = 0;  s < sitelist.length;  s++) {
			var site = sitelist[s];
			var siteobelisks = [];
			for (var o = 0;  o < sitelist[s].obelisks.length;  o++) {
				var obelisk = sitelist[s].obelisks[o];
				var codex = db.codex[obelisk.codexdataId];
				if (codex && !obelisk.isBroken && codexneed[codex.id]) {
					codexneed[codex.id] = false;
					siteobelisks.push(obelisk);
					numscanned++;
				}
			}
			
			line = ('</li><li><a href="https://ruins.canonn.technology/#GS' + site.id + '">GS' + site.id + '</a>: '
					+ db.system[db.body[sitelist[s].bodyId].systemId].name + ' / '
					+ db.body[sitelist[s].bodyId].name + ' @ '
					+ site.latitude.toFixed(2) + ', '
					+ site.longitude.toFixed(2) + ' ('
					+ db.type[sitelist[s].ruintypeId].name + '); '
					+ getSysDist(s ? db.system[db.body[sitelist[s - 1].bodyId].systemId] : SYSTEM_MEENE, db.system[db.body[sitelist[s].bodyId].systemId]).toFixed(0) + ' LY, '
					+ db.body[sitelist[s].bodyId].distance + ' LS, '
					+ numscanned + '/' + numneed
			);
			text += line;
			textd += line;
			
			line = '<ul><li>';
			siteobelisks.sort(obeliskcmp);
			for (var o = 0;  o < siteobelisks.length;  o++) {
				var obelisk = siteobelisks[o];
				var codex = db.codex[obelisk.codexdataId];
				if (o > 0 && obelisk.obeliskgroupId != siteobelisks[o-1].obeliskgroupId) {
					line += '</li><li>';
				} else if (o > 0) {
					line += ' ';
				}
				line += db.group[obelisk.obeliskgroupId].name + obelisk.number + '(';
				line += db.artifact[db.category[codex.categoryId].artifactId].name.substring(0,2);
				if (codex.artifactId)
					line += '+' + db.artifact[codex.artifactId].name.substring(0,2);
				line += ':' + db.category[codex.categoryId].name.substring(0,1) + codex.entryNumber + (obelisk.isVerified ? '' : '?') + ')';
			}
			line += '</li></ul>';
			textd += line;
		}
		line = '</li><li>Return: Meene / Felice Dock; ' + getSysDist(SYSTEM_MEENE, db.system[db.body[sitelist[sitelist.length - 1].bodyId].systemId]).toFixed(0) + ' LY</li></ul>';
		text += line;
		textd += line;
		divexport.innerHTML = text;
		divexportd.innerHTML = textd;
	} else {
		span.innerText = '';
		divexport.innerHTML = '';
		divexportd.innerHTML = '';
	}
	var any = false;
	for (var codexId in db.codex) {
		var td = document.getElementById('td_codex_'+codexId);
		var selected = document.getElementById('checkbox_codex_'+codexId).checked;
		td.className = td.className.replace(' covered','').replace(' selected','')
			+ (codexflag[codexId] ? ' covered' : '')
			+ (selected ? ' selected' : '')
		;
		any = any || selected;
	}
	document.getElementById('checkbox_codex_all').checked = !any;
} // updateSiteCover()


function optimizeSiteCoverage() {
	var t0 = (new Date()).getTime();
	
	var allcodexes = document.getElementById('checkbox_codex_all').checked;
	var typeCodexes = {}, numtypes = 0;
	for (var codexId in db.codex) {
		var codex = db.codex[codexId];
		codex.cat1mask = (codex.categoryId != 1) ? 0 : (1 << codex.entryNumber);
		codex.cat2mask = (codex.categoryId != 2) ? 0 : (1 << codex.entryNumber);
		codex.cat3mask = (codex.categoryId != 3) ? 0 : (1 << codex.entryNumber);
		codex.cat4mask = (codex.categoryId != 4) ? 0 : (1 << codex.entryNumber);
		codex.cat5mask = (codex.categoryId != 5) ? 0 : (1 << codex.entryNumber);
		
		if (codex.sites && codex.sites.length > 0) {
			codex.sites.sort(function (site1,site2) { return site1.codexes.length - site2.codexes.length; });
			
			if (allcodexes || document.getElementById('checkbox_codex_' + codexId).checked) {
				codex.typeSites = {};
				var s = codex.sites.length;
				while (s-- > 0) {
					var typeId = codex.sites[s].ruintypeId;
					if (!codex.typeSites[typeId])
						codex.typeSites[typeId] = [];
					codex.typeSites[typeId].push(codex.sites[s]);
				}
				
				var majorityTypeId = -1;
				for (var typeId in codex.typeSites) {
					codex.typeSites[typeId].sort(function (site1,site2) { return site1.codexes.length - site2.codexes.length; });
					if (!codex.typeSites[majorityTypeId] || codex.typeSites[majorityTypeId].length < codex.typeSites[typeId].length) {
						if (codex.typeSites[majorityTypeId])
							console.log('WARNING: ignoring codex #'+codexId+' ('+db.category[codex.categoryId].name+' '+codex.entryNumber+') at ruin type '+db.type[majorityTypeId].name);
						majorityTypeId = typeId;
					} else {
						console.log('WARNING: ignoring codex #'+codexId+' ('+db.category[codex.categoryId].name+' '+codex.entryNumber+') at ruin type '+db.type[typeId].name);
					}
				}
				
				if (!typeCodexes[majorityTypeId]) {
					typeCodexes[majorityTypeId] = [];
					numtypes++;
				}
				typeCodexes[majorityTypeId].push(codex);
			}
		}
	}
	
	var typeSolutions = {}, sitelist = [];
	for (var siteId in db.site) {
		var site = db.site[siteId];
		
		if (site.codexes && site.codexes.length > 0) {
			site.codexes.sort(function (codex1,codex2) { return codex1.sites.length - codex2.sites.length; });
			
			site.cat1mask = site.cat2mask = site.cat3mask = site.cat4mask = site.cat5mask = 0;
			var c = site.codexes.length;
			while (c-- > 0) {
				site.cat1mask |= site.codexes[c].cat1mask;
				site.cat2mask |= site.codexes[c].cat2mask;
				site.cat3mask |= site.codexes[c].cat3mask;
				site.cat4mask |= site.codexes[c].cat4mask;
				site.cat5mask |= site.codexes[c].cat5mask;
			}
		}
		
		var typeId = site.ruintypeId;
		if (!typeSolutions[typeId]) {
			typeSolutions[typeId] = [];
			typeSolutions[typeId].push([[]]);
			if (ALLOW_EXTRA_SITE)
				typeSolutions[typeId].push([[]]);
		}
		typeSolutions[typeId][0][0].push(site);
		if (ALLOW_EXTRA_SITE)
			typeSolutions[typeId][1][0].push(site);
		sitelist.push(site);
	}
	var solutions = [{
			'numsites':sitelist.length,
			'numbodies':sitelist.length,
			'numsystems':sitelist.length,
			'sitelist':sitelist
	}];
	
	var types = [];
	var progress = document.getElementById('span_progress');
	for (var typeId in typeCodexes) {
		types.push(typeId);
		typeCodexes[typeId].sort(function(codex1,codex2) { return codex2.typeSites[typeId].length - codex1.typeSites[typeId].length; });
		optimizeSiteCoverageRecurse(typeId, typeSolutions[typeId], typeCodexes[typeId], typeCodexes[typeId].length - 1, [], 0, 0, 0, 0, 0);
//		progress.style.width = (100.0 * types.length / numtypes).toFixed(0) + '%';
	}
	optimizeSiteCoverageCombine(solutions, typeSolutions, types, types.length - 1, [], ALLOW_EXTRA_SITE ? 1 : 0);
//	progress.style.width = '0';
	
	for (var o = 0;  o < solutions.length;  o++) {
		evaluateSolution(solutions[o]);
	//	console.log("solution #"+(o+1)+": ls="+distLS.toFixed(2)+" ly="+distLY.toFixed(2)+" avgSol="+distLYsol.toFixed(2)+" avgMid="+distLYmid.toFixed(2));
	}
	solutions.sort(function(soln1, soln2) { return soln1.score - soln2.score; });
	console.log("best solution with "+solutions[0].numsites+" sites on "+solutions[0].numbodies+" bodies in "+solutions[0].numsystems+" systems, ~"+solutions[0].distLS.toFixed(2)+" LS cruise, ~"+solutions[0].distLY.toFixed(2)+" LY jump");
	
	for (var siteId in db.site)
		document.getElementById('checkbox_site_'+siteId).checked = false;
	var s = solutions[0].sitelist.length;
	while (s-- > 0)
		document.getElementById('checkbox_site_'+solutions[0].sitelist[s].id).checked = true;
	updateSiteCover();
	
	var t1 = (new Date()).getTime();
	console.log(solutions.length+' solutions with '+solutions[0].numsites+' sites; '+(t1-t0)+'ms elapsed');
} // optimizeSiteCoverage()


function optimizeSiteCoverageRecurse(typeId, solutions, codexes, next, sitelist, cat1mask, cat2mask, cat3mask, cat4mask, cat5mask) {
	var codex;
	while ((codex = codexes[next]) && ((cat1mask & codex.cat1mask) || (cat2mask & codex.cat2mask) || (cat3mask & codex.cat3mask) || (cat4mask & codex.cat4mask) || (cat5mask & codex.cat5mask)))
		next--;
	if (next < 0) {
		if (sitelist.length < solutions[0][0].length) {
			if (ALLOW_EXTRA_SITE)
				solutions[1] = solutions[0];
			solutions[0] = [ sitelist.slice() ];
		} else if (sitelist.length <= solutions[0][0].length) {
			solutions[0].push( sitelist.slice() );
		} else if (ALLOW_EXTRA_SITE && sitelist.length < solutions[1][0].length) {
			solutions[1] = [ sitelist.slice() ];
		} else if (ALLOW_EXTRA_SITE && sitelist.length <= solutions[1][0].length) {
			solutions[1].push( sitelist.slice() );
		}
	} else if (sitelist.length < solutions[ALLOW_EXTRA_SITE ? 1 : 0][0].length) {
		var sites = codex.typeSites[typeId];
		var s = sites.length;
		while (s-- > 0) {
			var site = sites[s];
			sitelist.push(site);
			optimizeSiteCoverageRecurse(
					typeId, solutions, codexes, next - 1, sitelist,
					cat1mask | site.cat1mask,
					cat2mask | site.cat2mask,
					cat3mask | site.cat3mask,
					cat4mask | site.cat4mask,
					cat5mask | site.cat5mask
			);
			sitelist.pop();
		}
	}
} // optimizeSiteCoverageRecurse()


function optimizeSiteCoverageCombine(solutions, typeSolutions, types, next, sitelist, extra) {
	if (next < 0) {
		var siteflag={}, bodyflag={}, systemflag={};
		var numsites=0, numbodies=0, numsystems=0;
		var uniquesites=[];
		var s = sitelist.length;
		while (s-- > 0) {
			var siteId = sitelist[s].id;
			if (!siteflag[siteId]) {
				siteflag[siteId] = true;
				numsites++;
				uniquesites.push(sitelist[s]);
				var bodyId = sitelist[s].bodyId;
				if (!bodyflag[bodyId]) {
					bodyflag[bodyId] = true;
					numbodies++;
					var systemId = db.body[bodyId].systemId;
					if (!systemflag[systemId]) {
						systemflag[systemId] = true;
						numsystems++;
					}
				}
			}
		}
		if (false && solutions.length > 0) { // TODO: maybe LS matters more than numbodies/systems?
			if (numbodies > solutions[0].numbodies) {
				return;
			} else if (numbodies < solutions[0].numbodies) {
				solutions.length = 0;
			} else if (numsystems > solutions[0].numsystems) {
				return;
			} else if (numsystems < solutions[0].numsystems) {
				solutions.length = 0;
			}
		}
		solutions.push({
				'numsites':numsites,
				'numbodies':numbodies,
				'numsystems':numsystems,
				'sitelist':uniquesites
		});
	} else {
		var nextsolutions = typeSolutions[types[next]][0];
		var s = nextsolutions.length;
		while (s-- > 0) {
			optimizeSiteCoverageCombine(solutions, typeSolutions, types, next - 1, sitelist.concat(nextsolutions[s]), extra);
		}
		if (extra > 0) {
			nextsolutions = typeSolutions[types[next]][1];
			s = nextsolutions.length;
			while (s-- > 0) {
				optimizeSiteCoverageCombine(solutions, typeSolutions, types, next - 1, sitelist.concat(nextsolutions[s]), extra - 1);
			}
		}
	}
} // optimizeSiteCoverageCombine()


function getSysDist(sys1, sys2) {
	var pow = Math.pow;
	return pow( (
		pow(sys1.edsmCoordX - sys2.edsmCoordX, 2) +
		pow(sys1.edsmCoordY - sys2.edsmCoordY, 2) +
		pow(sys1.edsmCoordZ - sys2.edsmCoordZ, 2)
	), 0.5);
} // getSysDist()


var SYSTEM_MEENE = { 'id':-1, 'edsmCoordX':118.78125, 'edsmCoordY':-56.4375, 'edsmCoordZ':-97.1875 };


function evaluateSolution(soln) {
	var pow = Math.pow;
	
	soln.numsites = 0;
	soln.numbodies = 0;
	soln.numsystems = 0;
	var bodyflag = {}, systemflag = {}, systems = [SYSTEM_MEENE];
	var distLS = 0, midX = 0, midY = 0, midZ = 0;
	for (var s = 0;  s < soln.sitelist.length;  s++) {
		soln.numsites++;
		var body = db.body[soln.sitelist[s].bodyId];
		var system = db.system[body.systemId];
		if (!bodyflag[body.id]) {
			soln.numbodies++;
			bodyflag[body.id] = true;
			distLS += body.distance;
			if (!systemflag[system.id]) {
				soln.numsystems++;
				systemflag[system.id] = true;
				systems.push(system);
				midX += system.edsmCoordX;
				midY += system.edsmCoordY;
				midZ += system.edsmCoordZ;
			}
		}
	}
	systems.sort(function(sys1,sys2) { return getSysDist(sys1,SYSTEM_MEENE) - getSysDist(sys2,SYSTEM_MEENE); });
	systems.push(SYSTEM_MEENE);
	var imp = 0;
	for (var i = 0, stop = false;  i < 10 && !stop;  i++) {
		stop = true;
		var s = systems.length - 2;
		while (s-- > 1) {
			var swap = (
				(getSysDist(systems[s-1],systems[s]) + getSysDist(systems[s+1],systems[s+2])) -
				(getSysDist(systems[s-1],systems[s+1]) + getSysDist(systems[s],systems[s+2]))
			);
			if (swap > 0) {
				imp += swap;
				stop = false;
				var system = systems[s];
				systems[s] = systems[s+1];
				systems[s+1] = system;
			}
		}
	}
//	if (imp > 0) console.log("solution #"+(o+1)+" improved "+imp.toFixed(2)+"LY after "+i+" iterations");
	midX /= systems.length;
	midY /= systems.length;
	midZ /= systems.length;
	soln.sitelist.sort(function(site1,site2) {
		return (site1.bodyId == site2.bodyId) ? (site1.id - site2.id) : (
			(db.body[site1.bodyId].systemId == db.body[site2.bodyId].systemId) ? (db.body[site1.bodyId].distance - db.body[site2.bodyId].distance) : (
				systems.indexOf(db.system[db.body[site1.bodyId].systemId]) - systems.indexOf(db.system[db.body[site2.bodyId].systemId])
			)
		);
	});
	
	var distLY = 0, distLYsol = 0, distLYmid = 0;
	for (var s = 0;  s < systems.length;  s++) {
		var system = systems[s];
		distLY    += getSysDist(system, s ? systems[s-1] : system);
		distLYsol += pow( pow(system.edsmCoordX     ,2) + pow(system.edsmCoordY     ,2) + pow(system.edsmCoordZ     ,2), 0.5);
		distLYmid += pow( pow(system.edsmCoordX-midX,2) + pow(system.edsmCoordY-midY,2) + pow(system.edsmCoordZ-midZ,2), 0.5);
	}
	distLYsol /= systems.length;
	distLYmid /= systems.length;
	
	soln.distLS = distLS;
	soln.distLY = distLY;
	soln.distLYsol = distLYsol;
	soln.distLYmid = distLYmid;
	soln.score = (
		distLY / parseFloat(document.getElementById('text_opt_ly').value)
		+ distLS / parseFloat(document.getElementById('text_opt_ls').value)
		+ soln.numsites / parseFloat(document.getElementById('text_opt_site').value)
	);
} // evaluateSolution()


window.addEventListener('DOMContentLoaded', onDOMContentLoaded);
	</script>
</head>
<body>
</body>
</html>
