
<!DOCTYPE html>
<html>
<head>
	
	<title>Guardian Ancient Ruins</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="leaflet.css" />
	<link rel="stylesheet" href="ruins.css" />
	<script src="scripts/leaflet.js"></script>
	<script src="scripts/jquery-3.1.1.min.js"></script>
	
</head>
<body>


<div id="mapid" style="width: 100%; height: 600px;"></div>
<script>
	$( document ).ready(function() {

		window.ruins = {
			map:L.map('mapid', {
				center: [0,0],
				zoom: -20,
				crs: L.CRS.Simple
			}),
			mapControls:null,
			defaultImageBounds:[[0,0], [750,750]],

			//For tooling only
			tooling: {
				capture: false,
				paths: [],
				init: function(){
					this.capture = true;

					$('#obeliskSetPath').click(function(e){
						var obeliskSet = {
							id:$('#obeliskNumber').val(),
							points: ruins.tooling.paths
						};

						document.getElementById('log').value = document.getElementById('log').value + JSON.stringify(obeliskSet) + ',\n';
						//reset the array
						ruins.tooling.paths = [];

						//Increment
						$('#obeliskNumber').val(1 + Number($('#obeliskNumber').val()));

					})
					

				},
				addPoint:function(latlng){
					//Add an array
					this.paths.push([latlng.lat,latlng.lng]);
					//Flag
					$(obeliskPointFlag).fadeIn(100).fadeOut(100);
					
				}

				/*
				Obelisk Number: <input type="text" id="obeliskNumber" value="1"><BR>
				Obelisk Number: <input type="button" id="obeliskSetPath" value="Add"><BR>
				*/
			}

		}

		$('.ruinbtn').click(function(e){
			var ruinid = $(this).attr('href').replace(/#/g,'');
			var ruincombo = ruinid.split('.')[1];
			ruinid = ruinid.split('.')[0];

			setMap(ruinid,ruincombo);
		});


		window.ruins.map.on('click', onMapClick);


		setMap('alpha','abcdefghijklmnopq');

		
		//window.ruins.tooling.init();		

	});




	function onMapClick(e) {
		/*
	    popup.setLatLng(e.latlng)
	        .setContent("You clicked the map at " + e.latlng.toString())
	        .openOn(mymap);
	    */
	    
	    if(window.ruins.tooling.capture){
	    	window.ruins.tooling.addPoint(e.latlng);
	    }
	}



	function setMap(id,combo){
		//Clear existing layers
		window.ruins.map.eachLayer(function (layer) {
			window.ruins.map.removeLayer(layer);
		});

		//Remove old map controls
		if(window.mapControls){
			window.mapControls.remove();
			window.mapControls = null;
		}

		window.ruins.map.fitBounds(window.ruins.defaultImageBounds);

		//Now build layers
		var baseLayers = {};
		var overlays = {};

		//Add obelisks (ultimately to come from a JSON file associated with the grouping)
		var obelisksGroupOverlay = L.layerGroup();

		//Add obelisks (ultimately to come from a JSON file associated with the grouping)
		var obelisksNumberOverlay = L.layerGroup();

		//Ruin layout
		var ruinMapLayer = L.imageOverlay('maps/' + id + '/layout.svg', window.ruins.defaultImageBounds, {
				minZoom: 0,
				maxZoom: 5,
				attribution: 'Ruins diagram by Zebarmy',
				tms: true,
				autoZIndex: false
			}).addTo(window.ruins.map);

		//Add overlays
		obelisksGroupOverlay.addTo(window.ruins.map);
		obelisksNumberOverlay.addTo(window.ruins.map);

		//Overlays
		
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'a');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'b');		
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'c');

		
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'d');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'e');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'f');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'g');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'h');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'i');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'j');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'k');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'l');
		
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'m');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'n');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'o');
		
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'p');
		addCluster(obelisksGroupOverlay,obelisksNumberOverlay,id,'q');
		
		

		//Controls and overlay options
		window.ruins.mapControls = L.control.layers({'Ruins':ruinMapLayer},{'Obelisks':obelisksGroupOverlay,'Numbering':obelisksNumberOverlay},{collapsed:false,hideSingleBase:true})

		//window.ruins.mapControls = L.control.layers({'Ruins':ruinMapLayer},{collapsed:false,hideSingleBase:true})
		window.ruins.mapControls.addTo(window.ruins.map);
	}

	function addCluster(obeliskLayer,numberLayer,id,cluster){

		//Overlays
		var obeliskMapOverlay = L.imageOverlay('maps/' + id + '/cluster.' + cluster + '.obelisks.svg', window.ruins.defaultImageBounds, {
				minZoom: 0,
				maxZoom: 5,
				tms: true,
				zIndex: 500
			}).addTo(window.ruins.map);

		//Add to overlay
		obeliskLayer.addLayer(obeliskMapOverlay);
		
		
		
		var numberMapOverlay = L.imageOverlay('maps/' + id + '/cluster.' + cluster + '.numbers.svg', window.ruins.defaultImageBounds, {
				minZoom: 0,
				maxZoom: 5,
				tms: true,
				zIndex: 700
			}).addTo(window.ruins.map);

		//Add to overlay
		numberLayer.addLayer(numberMapOverlay);
		
		
		
		

		/*
		//Get the JSON data for the obelisk group
		var jqxhr = $.getJSON( 'http://cann2.sonargaming.com/maps/' + id + '/cluster.a.js', function(e) {

			  $.each(e.obelisks, function( index, item ) {

				  var polygon = addObeliskPoly('A',item.id,item.points);
				  obelisksGroupOverlay.addLayer(polygon);
				});

			});
		*/

	}

	function addObeliskPoly(cluster,number,points){
	
		var polygon = L.polygon(points, {color: 'blue'});

		polygon.on('click', function(e) {
			alert('Obelisk ' + cluster + ' ' + number);
  		});

		return polygon;
	}

	function addObeliskPolyZ(cluster,number,point,orientation){
		var p1 = null;
		var p2 = null;
		var p3 = null;

		if(orientation == 180){
			//orient up
			var p1 = point;
			
			var p2 = [p1[0]+2.6, p1[1]-1.5];

			var p3 = [p1[0]+2.6, p1[1]+1.5];
		}else{

			//orient down
			var p1 = point;
			
			var p2 = [p1[0]-2.6, p1[1]-1.5];

			var p3 = [p1[0]-2.6, p1[1]+1.5];
		}
	
		var polygon = L.polygon([
		    p1,
		    p2,
		    p3
		], {color: 'blue'});

		polygon.on('click', function(e) {
			alert('Obelisk ' + cluster + ' ' + number);
  		});

		return polygon;
	}	
</script>

<!--
	<div id="tooling">
		Obelisk Number: <input type="text" id="obeliskNumber" value="1"><BR>
		Obelisk Number: <input type="button" id="obeliskSetPath" value="Add">
		<div id="obeliskPointFlag" style="display:none">
			Point Captured
		</div>

		<BR>
		<HR>
		<textarea id="log" style="width:100%; height:400px; "></textarea>
	</div>
-->


</body>
</html>
