
<!DOCTYPE html>
<html>
<head>

	<title>Guardian Ancient Ruins</title>

	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

	<link rel="stylesheet" href="ruins.css" />

	<script src="scripts/jquery-3.1.1.min.js"></script>
	<script src="scripts/jquery.panzoom.js"></script>
	<script src="scripts/guardian.ruins.js"></script>
</head>

<body>
	<div id="main">
		<section id="systems">
			<div id="system_heading">
				<h1>Guardian Ancient Ruins</h1>
				<div id="return_to_map">
					<div>Return to Map</div>
				</div>

			</div>
			<table id="ruin-list">
				<tr>
					<th width="20%">System/Body</th>
					<th>Ruin</th>
					<th>Type</th>
					<th>Coordinates</th>
				</tr>
			</table>
		</section>

	    <section id="map" style="display:none">
	    	<div id="map_heading">
	    		<h1>System | Body | Coords</h1>
	    	</div>

	    	<div class="parent">
				<div class="panzoom noselect" id="ruin-map">
					&nbsp;
				</div>
			</div>


			<div id="mapcontrols" class="noselect">
				<div id="return_to_systems">
					<div>Select Ruin</div>
				</div>

				<div id="zoom-in" class="button first" title="Zoom In">&nbsp;</div>

				<div id="zoom-out" class="button" title="Zoom Out">&nbsp;</div>

				<div id="zoom-reset" class="button" title="Reset Zoom">&nbsp;</div>
			</div>


			<div id="info" class="down">
				<h2 id="info_bar">
						<span class="chevron">&#x25B4</span> Information <span class="chevron">&#x25B4</span>
				</h2>
				<div class="panel">
					<div class="panel-section">
						<h3>Scans</h3>
						<table id="obelisks">
							<tr>
								<th>Group/Obelisk</th>
								<th>Item 1</th>
								<th>Item 2</th>
								<th>Result</th>
							</tr>
							<tr id="focus-a-1" class="obelisk-selection">
								<td>A01</td><td>Urn</td><td>Casket</td><td>Biology 1</td>
							</tr>
							<tr id="focus-a-3" class="obelisk-selection">
								<td>A03</td><td>Thing 3</td><td>Thing 4</td><td>Culture 1</td>
							</tr>
							<tr id="focus-a-5" class="obelisk-selection">
								<td>A05</td><td>Thing 3</td><td>Thing 4</td><td>Culture 2</td>
							</tr>
							<tr id="focus-d-8" class="obelisk-selection">
								<td>D08</td><td>Thing 3</td><td>Thing 4</td><td>Culture 3</td>
							</tr>
							<tr id="focus-n-7" class="obelisk-selection">
								<td>N07</td><td>Thing 3</td><td>Thing 4</td><td>Biology 4</td>
							</tr>
							<tr id="focus-i-19" class="obelisk-selection">
								<td>I19</td><td>Thing 3</td><td>Thing 4</td><td>Culture 5</td>
							</tr>

						</table>
					</div>

				</div>

			</div>


	    </section>

	<!-- Pop up -->
	<div id="ruin_obelisk_data" style="display:none">
		<div class="obelisk">
			<div>
				<span id="scan_obelisk">Obelisk</span> - <span class="scan" id="scan_result">Scan</span>
			</div>
		</div>

		<div id="scan_data_panel">
			<div class="object" id="scan_object1icon">
				<div class="object1" id="scan_object1">Obelisk 1</div>
			</div>
			<div class="object" id="scan_object2icon">
				<div class="object2" id="scan_object2">Obelisk 2</div>
			</div>
		</div>

		<div id="ruin_obelisk_data_close">&nbsp;</div>
	</div>

	<!--
	<div id="ruin_obelisk_data" style="">
		<div class="obelisk">
			<div>
				<span id="scan_obelisk">Obelisk</span> - <span class="scan" id="scan_result">Scan</span>
			</div>
		</div>

		<div id="scan_data_panel">
			<div class="object" id="scan_object1icon">
				<div class="object1" id="scan_object1">Obelisk 1</div>
			</div>
			<div class="object" id="scan_object2icon">
				<div class="object2" id="scan_object2">Obelisk 2</div>
			</div>
		</div>

		<div class="ruin_obelisk_data_close">&nbsp;</div>
	</div>
	-->

	<!-- Notice Panel -->

	<div id="notice" style="display:none">
		Notice Panel
	</div>


	</div>

	      <script>
			window.systems = {};


		  	/* Mapping Mapping Mapping Mapping Mapping Mapping Mapping Mapping Mapping  */
		  	/* Mapping Mapping Mapping Mapping Mapping Mapping Mapping Mapping Mapping  */
		  	/* Mapping Mapping Mapping Mapping Mapping Mapping Mapping Mapping Mapping  */

	      	function prepMapUI(){
			  	window.ruins = Guardian.getRuin({
			  		panzoom:$(".panzoom"),

			  		onMapReady: function(type){
			  			//Hide notice
			  			hideNotice();

			  			//Clear existing gropus
			        	window.ruins.groups.clearGroups();

			  			//Add those that exist in the current ruin
			  			$.each(window.currentRuin.obelisks,function(group,obeliskData){
			  				window.ruins.groups.addGroup(group,obeliskData);
			  			})

			  			//Hide all groups for the given type
						window.ruins.groups.hideAllForType();

						//Now show those we've added
						window.ruins.groups.showAll();

						//Disable obelisks that are "broken"
						$.each(window.currentRuin.obelisks,function(group,obeliskData){
							$.each(obeliskData,function(number,data){
								if(0 === data){
									window.ruins.disableObelisk(group,number);
								}
						    });
						})

						//Reset the zoom
						window.ruins.zoomReset();

						//And present
			  			showMap();


			  		},
			  		onMapFailed: function(failure){
			  			showNotice('Map problem encountered: ' + failure.statusText,false);
			  		},
			  		onObeliskSelected: onMapSelection,
			  		onNumberSelected: onMapSelection
			  	});

			  	//Get our site scans and store it
			  	getSiteScans();

		        //Scan Data menu
		        $('#ruin_obelisk_data_close').on('click',function(e){
		        	//Hide the popup
		        	$('#ruin_obelisk_data').hide();
		        });

		        //Handle closing if clicked outside
		        $(document).on('click',function(event) {
		        	var clickedItem = $(event.target);
		        	//Ignore if this is a number or obelisk.  Those we expect to trigger this event or change the scan displayed
		        	if(clickedItem.hasClass('ruin-number') || clickedItem.hasClass('ruin-obelisk')){
		        		return;
		        	}

					if( !(clickedItem.id == "ruin_obelisk_data" || clickedItem.parents("#ruin_obelisk_data").length) ){
						if($('#ruin_obelisk_data').css('display') === 'block' ){
							$('#ruin_obelisk_data').hide();
						}
					}
				})


		        //Bind our more control
		        $('#info_bar').on('click',function(e){
		        	if($('#info').hasClass('down')) {
			        	showInfoBar();
					}else{
						hideInfoBar();
					}
		        });


				//Test handle obelisk items
				$('.obelisk-selection').css( 'cursor', 'pointer' );
				$('.obelisk-selection').on('click',function(e){
					//Get the obelisk and identify the data from the id
					var obData = e.target.parentElement.id.split('-');

					//Hide
					hideInfoBar();

					//Focus on the obelisk
					window.ruins.focusOnObelisk(obData[1],obData[2]);
				});


				//Handle the zoom controls manually
				$("#zoom-in").on('click', function(){
					window.ruins.zoomIn();
				});

				$("#zoom-out").on('click', function(){
					window.ruins.zoomOut();
				});

				$("#zoom-reset").on('click', function(){
					window.ruins.zoomReset();
				});

				$("#return_to_systems").on('click', function(){
					//Enable navigation back
					$('#return_to_map').show();
					//Show listing
					showSystems();
				});


	      	}



	      	function showMap(){
	  			//Scroll up
	  			$(window).scrollTop(0);

				$('#systems').hide();
				$('#map').show();
	      	}

	      	function showSystems(){
				$('#map').hide();
				$('#systems').show();
	      	}

	        function onMapSelection(e,type,group,number){
	        	//Get the scan details for the given obelisk set
	        	console.log('Select:' + [type,group,number].join('-')); //testing

	        	if(!window.ruins.typeData[type]){return;}
	        	if(!window.ruins.typeData[type][group]){return;}
	        	if(!window.ruins.typeData[type][group][number]){return;}

	        	var scanData = window.ruins.typeData[type][group][number];

	        	var numDisplay = number;
	        	if(numDisplay < 9){
	        		numDisplay = '0' + numDisplay;
	        	}

	        	if(scanData){
	        		showScanData(group.toUpperCase() + numDisplay,scanData.items[0],scanData.items[1],scanData.scan);
	        	}
	  		}

	  		function showScanData(obelisk,object1,object2,data){
	  			//Display
	  			var object1 = object1 || 'None';
	  			var object2 = object2 || 'None';

				//Testing
	  			$('#scan_obelisk').text(obelisk);
				$('#scan_object1').text(object1);
				$('#scan_object1icon').css('background-image','url("images/maps/ruin_' + object1.toLowerCase() + '.png")');

				$('#scan_object2').text(object2);
				$('#scan_object2icon').css('background-image','url("images/maps/ruin_' + object2.toLowerCase() + '.png")');

				$('#scan_result').text(data);
				$('#ruin_obelisk_data').show();
	  		}

	        function showInfoBar(){
	        	$('#info').addClass('up');
				$('#info').removeClass('down');
				//Change chevron
				$('#info_bar .chevron').html('&#x25BE');
	        }

	        function hideInfoBar(){
				$('#info').addClass('down');
				$('#info').removeClass('up');
				//Change chevron
				$('#info_bar .chevron').html('&#x25B4');
	        }

	        function ruinSelected(systemId,
	        	ruinId,type){
	        	//Start by loading the map type
	        	showNotice('Getting Ruin Info',true);

	        	//var ruinRequest = 'https://canonnapi.sonargaming.com/api/v1/maps/ruininfo/' + encodeURIComponent(parseInt(ruinId));
	        	var ruinRequest = 'mock/ruininfo.json';

	        	//http://canonnapi.sonargaming.com/api/v1/maps/ruininfo/{ruinId}
	        	//mock/ruininfo.json
				$.get(ruinRequest).done(function(ruinInfo) {
						//Add obelisks if missing
						ruinInfo.obelisks = ruinInfo.obelisks || {};

						//Store ruin data in currentRuin;
						window.currentRuin = ruinInfo;

			  			//Update map header info
			  			$('#map_heading h1').text([
			  				window.systems[systemId].systemName,
			  				window.currentRuin.bodyName,
			  				window.currentRuin.coordinates.join(', ')
			  			].join(' | '));

						//And show
						showNotice('Opening Ruin Map',true);
						window.ruins.setRuinType(type);
					})
					.fail(function(d, textStatus, error){
						showNotice("Getting Ruin Info failed: " + error ,false);
					});
	        }

		  	/* Selection Selection Selection Selection Selection Selection Selection */
		  	/* Selection Selection Selection Selection Selection Selection Selection */
		  	/* Selection Selection Selection Selection Selection Selection Selection */
		  	/* Selection Selection Selection Selection Selection Selection Selection */
		  	function getSiteScans(){
		  		//Show status
        		showNotice('Getting Scan Listing',true);

        		//http://api2.sonargaming.com:8000/api/v1/maps/scandata

				$.get("https://canonnapi.sonargaming.com/api/v1/maps/scandata",{ format: "json"}).done(function(scanList) {
		        	hideNotice();

		        	//Add our data
		        	$.each(scanList,function(type,groups){
		        		window.ruins.addType(type,groups);
		        	});
				})
				.fail(function(d, textStatus, error){
					console.log(error);
					showNotice("Getting Site Scans failed: " + error ,false);
				});

		  	}


	        function getRuinList(){

	        	//Clear everything
        		$('#ruin-list').find("tr:gt(0)").remove();

        		//Show status
        		showNotice('Getting Ruin List',true);

				$.get("https://canonnapi.sonargaming.com/api/v1/maps/systemoverview").done(function(systemList) {
		        	hideNotice();

		        	//Clear existing
		        	window.systems = {};


					$.each(systemList,function(index,system){
						//Cache system & ruin info
						window.systems[system.systemId]=system;

						//System heading
						var bandClass = '';
						if(1 == (index % 2)){
							bandClass='band';
						}

						var systemId = $('<div/>').text(system.systemId).html();

						$('#ruin-list').append([
						'<tr class="ruin_list_system ' + bandClass + '" id="system-' + systemId + '">',
						    '<td colspan="4"><div class="expand_status" alt="expand-collapse icon"/>' + $('<div/>').text(system.systemName).html() + '</td>',
						'</tr>'
						].join(''));


		        		$.each(system.ruins,function(rindex,ruin){
		        			//Add the ruin to the associated Ruins and
							var ruinId = $('<div/>').text(ruin.ruinId).html();
							var ruinType = $('<div/>').text(ruin.ruinTypeName).html();

							bandClass = '';
							if(1 == (rindex % 2)){
								bandClass='ruinband';
							}


							$('#ruin-list').append([
							'<tr class="ruin_list_ruin ruin_system_' + systemId + ' ruin_' + ruinId + ' ' + bandClass + '" id="ruin-' + systemId + '-' + ruinType + '-' + ruinId + '"">',
							    '<td class="indented">' + $('<div/>').text(ruin.bodyName).html() + '</td>',
								'<td>' + 'GS' + ruin.ruinId + '</td>',
							    '<td>' + ruinType + '</td>',
							    '<td>' + $('<div/>').text(ruin.coordinates.join(',')).html() + '</td>',
							'</tr>'
							].join(''));

		        		});
		        	});
				})
				.fail(function(d, textStatus, error){
					showNotice("Getting Ruin List failed: " + error ,false);
				});

	        }

	        function prepSelectionUI(){
	        	//Map Listing
	        	$('#return_to_map').on('click',function(e){
	        		//Show the map
	        		showMap();
	        	})


	        	//Added to the table since the elements are dynamically added
			  	$('#ruin-list').on('click',function(e){
			  		var clicked = $(e.target);
			  		var row = $(clicked.closest('tr'));

			  		if(row.hasClass('ruin_list_system')){
			  			//Display all ruins in the given system
			  			if(row[0].id){
			  				//Get the system ID
			  				var idSystem = row[0].id.split('-');

			  				if(2 === idSystem.length){
				  				if(row.hasClass('expanded')){
				  					//collapse
									row.addClass('collapsed');
									row.removeClass('expanded');
									//Hide all items that are "children" of this
			  						$('.ruin_system_' + idSystem[1]).hide();
				  				}else{
				  					//expand
				  					row.addClass('expanded');
				  					row.removeClass('collapsed');
				  					//Show all items that are "children" of this
			  						$('.ruin_system_' + idSystem[1]).show();
				  				}


			  				}
			  			}

			  		}else if(row.hasClass('ruin_list_ruin')){
			  			//Display ruin
				  		if(row[0].id){
					  		var idType=row[0].id.split('-');

					  		if(4 === idType.length){
								ruinSelected(idType[1], idType[3], idType[2].toLowerCase());
					  		}
				  		}
			  		}


			  	});
			  }

			function showNotice(noticeText,loading){
				if(loading){
					$('#notice').addClass('loading');
				}else{
					$('#notice').removeClass('loading');
				}
				$('#notice').text(noticeText,true).show();


			}

			function hideNotice(noticeText){
				$('#notice').fadeOut();
			}



			$( document ).ready(function() {
				//Prep the UI's
			  	prepSelectionUI();
			  	prepMapUI();

			  	//Shared
			  	$('#notice').on('click',function(e){
			  		$('#notice').hide();
			  	})

			  	//Load system
			  	getRuinList();

				//Stop host div from blocking bottom div during testing
				$('img[alt^="www."]').parent().parent().css('width','25%').css('right',0);


		      });   //document ready

	      </script>



</body>
</html>
